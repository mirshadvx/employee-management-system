{% extends "dashboard.html" %} {% block dashboard_content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
<div class="max-w-3xl mx-auto bg-white rounded-lg shadow-md p-6">
    <h2 class="text-2xl font-semibold mb-6 text-[#3C4142]">Create Custom Employee Form</h2>
    {% if error %}
    <div class="bg-red-100 text-red-700 rounded px-4 py-2 mb-4">{{ error }}</div>
    {% endif %} {% if success %}
    <div class="bg-green-100 text-green-700 rounded px-4 py-2 mb-4">Form created successfully!</div>
    {% endif %}
    <form method="POST" id="dynamic-form" novalidate>
        {% csrf_token %}
        <div class="mb-6">
            <label class="block text-[#3C4142] font-medium mb-1">Select Department</label>
            <select name="department" class="w-full px-3 py-2 border border-[#8FA68E]/30 rounded-md" required>
                <option value="">Select Department</option>
                {% for d in departments %}
                <option value="{{ d.id }}">{{ d.name }} - {{ d.label }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-[#3C4142]">Employee Fields</h3>
                <button
                    type="button"
                    class="flex items-center gap-2 px-3 py-2 bg-[#8FA68E] text-white rounded-md"
                    onclick="addFieldRow()"
                >
                    + Add Field
                </button>
            </div>
            <div id="fields-container" class="space-y-4"></div>
        </div>
        <div class="flex justify-end gap-2 pt-6 border-t mt-6">
            <a href="{% url 'employee_details' %}" class="px-4 py-2 text-[#3C4142] rounded-md hover:bg-[#E8DDD4]/50"
                >Cancel</a
            >
            <button type="submit" class="px-6 py-2 bg-[#8FA68E] text-white rounded-md hover:bg-[#3C4142]">
                Create Form
            </button>
        </div>
    </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
<script>
    let fieldIndex = 0;

    document.addEventListener("DOMContentLoaded", function () {
        var container = document.getElementById("fields-container");
        new Sortable(container, {
            animation: 150,
            ghostClass: "sortable-ghost",
            handle: ".drag-handle",
            onEnd: function (evt) {
                updateFieldOrder();
            },
        });

        if (!container.children.length) {
            addFieldRow();
        }
    });

    function addFieldRow(label = "", type = "", options = []) {
        const container = document.getElementById("fields-container");
        const row = document.createElement("div");
        row.className = "field-row border border-gray-300 rounded-md p-4 bg-gray-50 relative";
        row.innerHTML = `
        <input type="hidden" name="field_order" value="${fieldIndex}" />
        <div class="flex flex-col md:flex-row md:items-center md:gap-4">
            <div class="flex-none mr-2">
                <i class="fas fa-grip-vertical drag-handle cursor-move text-gray-500"></i>
            </div>
            <div class="flex-1 mb-3 md:mb-0">
                <label class="block text-[#3C4142] font-semibold mb-1">Field Label</label>
                <input type="text" name="field_label" placeholder="Field Label" value="${label}"
                       required class="px-3 py-2 border border-[#8FA68E]/30 rounded-md w-full"/>
            </div>
            <div class="flex-1 mb-3 md:mb-0">
                <label class="block text-[#3C4142] font-semibold mb-1">Field Type</label>
                <select name="field_type" required
                        class="px-3 py-2 border border-[#8FA68E]/30 rounded-md w-full" onchange="toggleOptionsArea(this, ${fieldIndex})">
                    <option value="">Select type</option>
                    <option value="text" ${type === "text" ? "selected" : ""}>Text</option>
                    <option value="number" ${type === "number" ? "selected" : ""}>Number</option>
                    <option value="email" ${type === "email" ? "selected" : ""}>Email</option>
                    <option value="date" ${type === "date" ? "selected" : ""}>Date</option>
                    <option value="boolean" ${type === "boolean" ? "selected" : ""}>Checkbox</option>
                    <option value="select" ${type === "select" ? "selected" : ""}>Dropdown</option>
                    <option value="textarea" ${type === "textarea" ? "selected" : ""}>Multiline</option>
                </select>
            </div>
            <div class="flex-none flex items-end mb-3 md:mb-0 pl-2">
                <button
                    type="button"
                    class="text-red-600 hover:text-red-800 text-xl font-bold leading-none"
                    onclick="this.closest('.field-row').remove()"
                    title="Remove field">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
        </div>
        <div id="options-area-${fieldIndex}" class="options-area mt-3" style="display: none;">
            <label class="block text-[#3C4142] font-semibold mb-1">Dropdown Options</label>
            <div id="options-container-${fieldIndex}" class="space-y-2">
            </div>
            <button type="button" class="mt-2 px-3 py-1 bg-[#8FA68E] text-white rounded-md" onclick="addOption(${fieldIndex})">Add Option</button>
        </div>
        `;
        container.appendChild(row);
        if (type === "select") {
            toggleOptionsArea(row.querySelector('select[name="field_type"]'), fieldIndex);
            options.forEach((option) => addOption(fieldIndex, option));
        }
        fieldIndex++;
    }

    function toggleOptionsArea(select, index) {
        const optionsArea = document.getElementById(`options-area-${index}`);
        if (select.value === "select") {
            optionsArea.style.display = "block";
        } else {
            optionsArea.style.display = "none";
        }
    }

    function addOption(index, value = "") {
        const container = document.getElementById(`options-container-${index}`);
        const optionDiv = document.createElement("div");
        optionDiv.className = "flex items-center space-x-2";
        optionDiv.innerHTML = `
            <input type="text" name="field_options_${index}" placeholder="Option" value="${value}" class="flex-1 px-3 py-2 border border-[#8FA68E]/30 rounded-md" required/>
            <button type="button" class="text-red-600 hover:text-red-800 font-bold text-xl leading-none" onclick="this.parentElement.remove()">&times;</button>
        `;
        container.appendChild(optionDiv);
    }

    function updateFieldOrder() {
        var fieldRows = document.querySelectorAll("#fields-container .field-row");
        fieldRows.forEach(function (row, index) {
            var orderInput = row.querySelector('input[name="field_order"]');
            if (!orderInput) {
                orderInput = document.createElement("input");
                orderInput.type = "hidden";
                orderInput.name = "field_order";
                row.appendChild(orderInput);
            }
            orderInput.value = index;
        });
    }
</script>

<style>
    .sortable-ghost {
        opacity: 0.5;
        background: #c8ebfb;
    }
    .field-row {
        cursor: move;
    }
    .drag-handle {
        cursor: move;
    }
</style>

{% endblock %}
